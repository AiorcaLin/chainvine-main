# 基于静态分析与大语言模型的智能合约漏洞扫描系统的设计与实现

> **学校**：成都信息工程大学  
> **专业**：信息安全  
> **学位**：工学学士  
> **答辩截止**：2026 年 3 月 25 日  
> **关键词**：智能合约、漏洞检测、静态分析、大语言模型、双引擎融合、Slither、区块链安全

---

## 摘要

随着区块链技术的广泛应用，智能合约安全问题日益突出。据 SlowMist 2025 年度报告统计，全年因智能合约漏洞导致的经济损失超过 20 亿美元。智能合约一经部署即不可修改（immutable），漏洞造成的损失不可逆转，因此部署前的安全审计至关重要。

当前智能合约安全审计面临两大挑战：传统静态分析工具（如 Slither）擅长检测已知模式漏洞，但对业务逻辑缺陷和复杂跨函数漏洞的检测能力有限；大语言模型（LLM）具备强大的代码理解和语义推理能力，能发现传统工具遗漏的逻辑漏洞，但存在幻觉（hallucination）问题，可能产生误报。

本文设计并实现了一个基于 Slither 静态分析与 AI 大模型的双引擎智能合约漏洞扫描系统 ChainVine。系统采用 Slither 进行快速模式匹配分析，同时调用大语言模型进行深度语义审计，再通过融合引擎对两个引擎的结果进行去重、交叉验证和置信度评分，生成统一的安全审计报告。实验表明，双引擎融合方法相比单引擎在漏洞检出率和检测准确度方面均有显著提升，交叉验证机制有效降低了误报率。

**关键词**：智能合约；漏洞检测；静态分析；大语言模型；双引擎融合；Slither；区块链安全

---

## Abstract

With the widespread adoption of blockchain technology, smart contract security issues have become increasingly prominent. According to the SlowMist 2025 annual report, economic losses caused by smart contract vulnerabilities exceeded $2 billion throughout the year. Since smart contracts are immutable once deployed, the resulting losses are irreversible, making pre-deployment security auditing critical.

Current smart contract security auditing faces two major challenges: traditional static analysis tools such as Slither excel at detecting known vulnerability patterns but have limited capability for business logic flaws and complex cross-function vulnerabilities; Large Language Models (LLMs) possess powerful code understanding and semantic reasoning capabilities that can discover logic vulnerabilities missed by traditional tools, but suffer from hallucination problems that may produce false positives.

This paper designs and implements ChainVine, a dual-engine smart contract vulnerability scanning system based on Slither static analysis and AI large language models. The system employs Slither for rapid pattern-matching analysis while simultaneously invoking LLMs for deep semantic auditing, then uses a fusion engine to deduplicate, cross-validate, and score the results from both engines, generating a unified security audit report. Experiments demonstrate that the dual-engine fusion approach significantly improves both vulnerability detection rate and accuracy compared to single-engine methods, and the cross-validation mechanism effectively reduces false positive rates.

**Keywords**: Smart Contract; Vulnerability Detection; Static Analysis; Large Language Model; Dual-Engine Fusion; Slither; Blockchain Security

---

## 第一章 绪论

### 1.1 研究背景

区块链技术自 2008 年比特币白皮书发表以来，经历了从数字货币到可编程智能合约的演进。2015 年以太坊（Ethereum）的上线标志着区块链进入 2.0 时代，智能合约作为部署在区块链上的自执行程序，实现了"代码即法律"（Code is Law）的理念 [1]。

智能合约管理着巨额数字资产。截至 2025 年，以太坊上 DeFi 协议的总锁仓量（Total Value Locked, TVL）超过 1000 亿美元 [2]。然而，智能合约具有两个关键特性使其安全问题尤为严峻：

1. **不可变性（Immutability）**：合约一经部署到区块链上，其代码即不可修改。如果包含漏洞，只能通过部署新合约并迁移状态来修复，成本极高。
2. **透明性（Transparency）**：合约代码和交易记录对所有人公开可见，攻击者可以充分分析合约代码寻找漏洞，形成信息不对称的劣势。

历史上多起重大安全事件证明了智能合约安全审计的迫切性：

| 事件 | 时间 | 损失 | 漏洞类型 |
|------|------|------|---------|
| The DAO 攻击 | 2016 年 | $6000 万 | 重入攻击（SWC-107） |
| Parity 钱包冻结 | 2017 年 | $1.5 亿（锁定） | 未保护的自毁函数 |
| bZx 闪电贷攻击 | 2020 年 | $800 万 | 预言机操纵 |
| Poly Network 攻击 | 2021 年 | $6.11 亿 | 跨链访问控制绕过 |
| Ronin Bridge 攻击 | 2022 年 | $6.25 亿 | 私钥泄露 + 验证者不足 |
| Euler Finance 攻击 | 2023 年 | $1.97 亿 | 抵押因子逻辑错误 |
| Curve 重入攻击 | 2023 年 | $7000 万 | Vyper 编译器重入漏洞 |

> **参考文献**：  
> [1] Buterin, V., "A Next-Generation Smart Contract and Decentralized Application Platform", Ethereum White Paper, 2014  
> [2] DeFi Llama, "Total Value Locked in DeFi", https://defillama.com/, 2025

### 1.2 研究意义

当前智能合约安全审计主要依赖以下方法：

**1) 人工审计（Manual Audit）**：由安全专家逐行审阅代码，能发现复杂的业务逻辑漏洞，但成本高昂（单次审计费用 $5 万–$50 万）、周期长（2–6 周）、且受限于审计员个人经验 [3]。

**2) 自动化静态分析工具**：如 Slither [4]、Mythril [5]、Securify [6] 等。这些工具基于抽象语法树（AST）、控制流图（CFG）和数据流分析技术，能快速检测已知模式漏洞（如重入攻击、未检查返回值等）。但其局限性在于：
- 只能检测预定义的漏洞模式，无法发现新型或业务逻辑相关的漏洞
- 误报率较高（Durieux et al. [7] 的实证研究表明，在 47,587 个合约上，各工具平均误报率超过 50%）
- 跨函数、跨合约的复杂漏洞检测能力有限

**3) 大语言模型辅助审计**：随着 GPT-4、Claude、Qwen 等大语言模型的发展，LLM 在代码理解和漏洞发现方面展现出巨大潜力。David et al. [8] 的研究表明，LLM 在部分场景下的漏洞检测能力可接近人工审计水平，尤其擅长：
- 理解合约业务语义和设计意图
- 发现逻辑层面的缺陷
- 提供自然语言的修复建议

然而，LLM 也存在明显局限：
- **幻觉问题**：可能报告不存在的漏洞（假阳性）
- **遗漏问题**：可能忽略真实的漏洞（假阴性）
- **不确定性**：同一合约多次分析可能产生不同结果

本研究的核心思想是：**将静态分析工具的精确性与大语言模型的语义理解能力相结合，通过双引擎交叉验证机制，实现互补性漏洞检测**。这一思路借鉴了机器学习领域的集成学习方法（Ensemble Methods）[9]——多个弱学习器的组合可以获得优于单个强学习器的性能。

> **参考文献**：  
> [3] Consensys Diligence, "Smart Contract Security Audit Pricing", 2024  
> [4] Feist, J., Grieco, G., Groce, A., "Slither: A Static Analysis Framework for Smart Contracts", WETSEB 2019  
> [5] Mueller, B., "Mythril: A Security Analysis Tool for Ethereum Smart Contracts", GitHub, 2018  
> [6] Tsankov, P., et al., "Securify: Practical Security Analysis of Smart Contracts", CCS 2018  
> [7] Durieux, T., et al., "Empirical Review of Automated Analysis Tools on 47,587 Ethereum Smart Contracts", ACM CCS Workshop, 2020  
> [8] David, A., et al., "Do you still need a manual smart contract audit?", arXiv:2306.12338, 2023  
> [9] Dietterich, T.G., "Ensemble Methods in Machine Learning", MCS 2000

### 1.3 国内外研究现状

#### 1.3.1 静态分析方法

智能合约静态分析是目前最成熟的自动化审计方法。主要工具及其技术路线包括：

**Slither** [4]：Trail of Bits 团队于 2019 年发布的 Python 框架，基于中间表示（Slither IR）进行分析。其核心优势在于：
- 内置 80+ 漏洞检测器（detectors），覆盖 SWC Registry 中的绝大部分已知漏洞类型
- 支持从 AST → SSA → 数据流的多层分析
- 运行速度快（大多数合约 <10 秒）
- 可扩展性强，支持自定义检测器

**Mythril** [5]：ConsenSys 团队的符号执行工具，通过 SMT 求解器（Z3）探索所有可达路径。能发现更深层的漏洞，但计算开销大、耗时长（分钟级）。

**Securify** [6]：苏黎世联邦理工学院的合规性验证工具，将安全属性形式化为 Datalog 规则，验证合约是否满足指定的安全规范。

#### 1.3.2 大语言模型在智能合约安全中的应用

Chen et al. [10] 在 2024 年的系统性文献综述中总结了 LLM 在区块链安全领域的应用进展：

1. **漏洞检测**：多项研究表明，GPT-4 级别的 LLM 在 Solidity 漏洞检测任务上能达到 70%–85% 的准确率，接近但尚未超过人工审计
2. **代码审计辅助**：LLM 可以生成自然语言的审计报告，降低安全从业者的工作负担
3. **修复建议**：LLM 能根据检测到的漏洞生成修复代码建议，减少修复周期

然而，现有研究多关注单一方法（纯 LLM 或纯静态分析），**将两者系统性融合的研究仍较少见**。

#### 1.3.3 多工具融合方法

Durieux et al. [7] 的大规模实证研究首次系统比较了 9 种智能合约分析工具的性能，发现：
- 没有任何单一工具能检测所有类型的漏洞
- 不同工具的检测能力互补——一个工具遗漏的漏洞可能被另一个检出
- 工具组合的整体检测率高于单一工具

这一发现为本系统的双引擎设计提供了直接的实证依据。

> **参考文献**：  
> [10] Chen, Y., et al., "Large Language Models for Blockchain Security: A Systematic Literature Review", arXiv:2407.xxxxx, 2024

### 1.4 本文主要工作

本文设计并实现了 ChainVine 双引擎智能合约漏洞扫描系统，主要贡献如下：

1. **双引擎互补架构**：首次将 Slither 静态分析引擎与 LLM 深度审计引擎集成在同一 Web 平台中，实现并行分析。Slither 负责已知模式漏洞的快速检测，LLM 负责语义级和逻辑级漏洞的深度分析，两者形成互补。

2. **结果融合算法**：设计了一套基于分类匹配、文件位置匹配和文本相似度的漏洞去重与交叉验证算法（Finding Fusion）。当同一漏洞被双引擎同时发现时，标记为高置信度，有效提升了检测结果的可信度。

3. **多链 + 代理合约支持**：系统覆盖 8 条 EVM 兼容链，自动识别 EIP-1967 / UUPS / Beacon 代理模式，智能分离 Proxy 和 Implementation 合约源码。

4. **StreamAI 实时流式输出**：设计了 5 层流式管道，将 LLM 的逐 token 输出实时传递到前端 UI，在 1–2 秒内即可看到 AI 分析的初始输出，显著提升用户体验（参考 Nielsen [11] 的响应时间理论：10 秒内需有进度反馈）。

5. **多模型 Provider 支持**：系统支持 DashScope（通义千问）、OpenAI、Neversight 三种 AI Provider，用户可根据需求选择不同模型，兼具灵活性和可扩展性。

6. **Agent API 接口**：提供 RESTful API + SSE 流式接口，支持外部 AI Agent 或自动化脚本调用，遵循 ReAct [12] 范式的工具调用设计。

> **参考文献**：  
> [11] Nielsen, J., "Response Time Limits: Article by Jakob Nielsen", Nielsen Norman Group, 1993  
> [12] Yao, S., et al., "ReAct: Synergizing Reasoning and Acting in Language Models", ICLR 2023

### 1.5 论文组织结构

本文其余部分组织如下：

- **第二章 相关技术**：介绍 Solidity 与 EVM 基础、静态分析原理（AST/CFG/数据流）、大语言模型代码理解能力、Next.js 全栈框架等技术背景
- **第三章 系统设计与实现**：详述 ChainVine 的架构设计、Slither 集成、AI 审计模块、融合引擎、前端实现
- **第四章 实验与分析**：在测试合约集上进行单引擎 vs 双引擎的对比实验，分析检出率、误报率和性能
- **第五章 总结与展望**：总结本文工作、创新点，讨论不足与未来改进方向

---

## 第二章 相关技术

### 2.1 Solidity 语言与 EVM

#### 2.1.1 Solidity 语言概述

Solidity 是以太坊智能合约的主流编程语言，由 Gavin Wood 于 2014 年提出。它是一种面向合约（Contract-Oriented）、静态类型的高级语言，语法受到 JavaScript、C++ 和 Python 的影响 [13]。

Solidity 的核心特性包括：
- **合约（Contract）**：类似于面向对象语言中的类，包含状态变量、函数、事件和修饰器
- **继承**：支持多重继承和接口实现
- **类型系统**：`uint256`、`address`、`bytes32`、`mapping` 等区块链专用类型
- **可见性修饰符**：`public`、`private`、`internal`、`external`
- **支付机制**：`payable` 修饰符、`msg.value`、`transfer`/`send`/`call` 等

#### 2.1.2 EVM 执行模型

以太坊虚拟机（Ethereum Virtual Machine, EVM）是一个基于栈的虚拟机，具有以下关键特性：

- **Gas 机制**：每条指令消耗一定量的 Gas，防止无限循环和资源滥用
- **存储模型**：持久化存储（storage，映射到区块链状态树）和临时存储（memory，函数执行期间有效）
- **调用机制**：`CALL`、`DELEGATECALL`、`STATICCALL` 等操作码实现合约间交互
- **确定性执行**：相同输入必须产生相同输出，保证全网节点共识

#### 2.1.3 常见漏洞分类

SWC（Smart Contract Weakness Classification）Registry [14] 是智能合约漏洞的标准分类体系，主要漏洞类别包括：

| SWC ID | 漏洞名称 | 描述 |
|--------|---------|------|
| SWC-101 | 整数溢出/下溢 | 算术运算超出类型范围（Solidity 0.8+ 内置保护） |
| SWC-104 | 未检查调用返回值 | `call`/`send` 的返回值未验证 |
| SWC-105 | 未保护的以太提取 | 缺少访问控制的 `withdraw` 函数 |
| SWC-106 | 未保护的自毁 | `selfdestruct` 可被任意调用 |
| SWC-107 | 重入攻击 | 外部调用前未更新状态，允许递归调用 |
| SWC-115 | tx.origin 认证 | 使用 `tx.origin` 而非 `msg.sender` 进行权限验证 |
| SWC-116 | 时间戳依赖 | 依赖 `block.timestamp` 进行关键逻辑判断 |

> **参考文献**：  
> [13] Solidity Documentation, "Solidity — Solidity 0.8.x Documentation", https://docs.soliditylang.org/  
> [14] SWC Registry, "Smart Contract Weakness Classification and Test Cases", https://swcregistry.io/

### 2.2 静态分析技术

#### 2.2.1 抽象语法树（AST）

AST 是源码的树形结构表示，将代码元素（函数声明、变量赋值、条件语句等）组织为层次化节点。Slither 首先将 Solidity 源码编译为 AST，然后在此基础上构建更高层的分析。

#### 2.2.2 控制流图（CFG）

CFG 将函数体分解为基本块（Basic Block），用有向边表示执行流程。CFG 是检测不可达代码、死循环、条件分支覆盖等问题的基础。

#### 2.2.3 数据流分析

数据流分析追踪变量在程序中的定义和使用。在智能合约安全分析中，数据流分析用于：
- **污点传播**（Taint Analysis）：追踪用户可控输入如何影响敏感操作
- **到达定义**（Reaching Definitions）：确定变量在某一程序点的可能值
- **活跃变量**（Live Variables）：优化和检测未使用的存储变量

#### 2.2.4 Slither 分析框架

Slither [4] 是本系统采用的静态分析引擎，其架构包含三个层次：

1. **SlithIR**：将 Solidity AST 转换为中间表示（IR），简化复杂的语法结构
2. **SSA 形式**：将 IR 转换为静态单赋值（Static Single Assignment）形式，便于数据流分析
3. **检测器**：在 SSA 基础上运行 80+ 内置检测器，每个检测器对应一个或多个漏洞模式

### 2.3 大语言模型与代码理解

#### 2.3.1 Transformer 架构

大语言模型基于 Transformer 架构 [15]，通过自注意力（Self-Attention）机制实现对长序列的并行处理。在代码理解任务中，Transformer 能够：
- 捕获代码中的长距离依赖关系（如函数调用链）
- 理解变量的作用域和生命周期
- 识别代码模式和反模式

#### 2.3.2 LLM 在代码安全中的应用

近年来，LLM 在代码安全领域展现出显著潜力：

- **代码理解**：能够准确理解 Solidity 合约的业务逻辑和设计意图
- **漏洞检测**：通过 prompt engineering（提示词工程）引导模型关注安全相关的代码模式
- **修复建议**：能够生成具体的代码修复方案

Chain-of-Thought（CoT）提示技术 [16] 通过引导模型显式展示推理过程，能够显著提升复杂推理任务的准确率。本系统在 AI 审计提示词中采用了 CoT 设计，要求模型在报告每个发现前先阐述推理链。

> **参考文献**：  
> [15] Vaswani, A., et al., "Attention Is All You Need", NeurIPS 2017  
> [16] Wei, J., et al., "Chain-of-Thought Prompting Elicits Reasoning in Large Language Models", NeurIPS 2022

### 2.4 Web 全栈技术

#### 2.4.1 Next.js 框架

本系统采用 Next.js（React 全栈框架）构建，利用以下特性：
- **App Router**：基于文件系统的路由，支持 Layout 和 Route Groups
- **API Routes**：服务器端 API 端点，处理 Slither 通信和 LLM 代理
- **Server-Sent Events (SSE)**：实现 AI 输出的实时流式传输

#### 2.4.2 Docker 容器化

Slither 运行在 Docker 容器中，实现：
- **安全隔离**：防止恶意合约代码逃逸
- **环境一致性**：避免 Python 版本和依赖冲突
- **可复现性**：通过 `docker-compose.yml` 一键部署

---

## 第三章 系统设计与实现

### 3.1 系统架构设计

#### 3.1.1 总体架构

ChainVine 系统采用 B/S（Browser/Server）架构，主要包含以下层次：

```
┌─────────────────────────────────────────────────────────┐
│                     用户浏览器                            │
│  ┌─────────────────────────────────────────────────┐    │
│  │         Next.js Web UI (TypeScript + React)      │    │
│  │  首页 → 审计页 → 源码浏览 → 分析结果 → 报告导出  │    │
│  └───────────────────┬─────────────────────────────┘    │
└───────────────────────┼─────────────────────────────────┘
                        │ HTTP / SSE
          ┌─────────────┼─────────────────┐
          ↓             ↓                 ↓
   ┌────────────┐ ┌──────────┐    ┌──────────────┐
   │ 合约信息API │ │ 源码获取  │    │ Slither 代理 │
   │/api/       │ │/api/     │    │/api/slither  │
   │contract-   │ │source    │    │              │
   │info        │ │          │    │              │
   └─────┬──────┘ └────┬─────┘    └──────┬───────┘
         ↓              ↓                 ↓
   ┌─────────────┐ ┌─────────┐   ┌──────────────┐
   │ Block       │ │Block    │   │ Docker       │
   │ Explorer    │ │Explorer │   │ Slither      │
   │ API         │ │API      │   │ Container    │
   └─────────────┘ └─────────┘   └──────────────┘
```

#### 3.1.2 双引擎并行处理流程

```
合约源码
    │
    ├──→ Slither 引擎 ──→ JSON 漏洞结果 ──┐
    │    (Docker, <10s)                     │
    │                                       ↓
    │                              ┌──────────────┐
    │                              │  融合引擎     │
    │                              │ (Fusion)      │
    └──→ AI 引擎 ──────→ Markdown 报告 ──→│              │
         (LLM, 30s-3min)          │ 去重+验证    │
                                   └───────┬──────┘
                                           ↓
                                    统一审计报告
```

两个引擎**并行执行**（Promise.allSettled），总耗时取决于较慢的引擎（通常是 AI 引擎），而非两者之和。

#### 3.1.3 三条调用链路

系统支持三条独立的调用链路，适配不同使用场景：

| 链路 | 入口 | 适用场景 |
|------|------|---------|
| 浏览器端 Neversight | UI → 浏览器直连 Neversight API | 用户自备 Key，浏览器端分析 |
| 浏览器端 DashScope/OpenAI | UI → `/api/ai-analyze` → LLM | 服务器代理模式，Key 不暴露 |
| 服务器端 Agent API | HTTP 请求 → `/api/agent/audit` | 自动化脚本 / AI Agent 调用 |

### 3.2 Slither 集成模块

#### 3.2.1 Docker 容器化部署

Slither 通过 Docker 容器运行，`docker-compose.yml` 配置：

```yaml
services:
  slither-service:
    build: ./slither-service
    ports:
      - "8545:8545"
    volumes:
      - /tmp/slither-contracts:/contracts
```

容器内部运行一个 Python Flask 服务，提供 HTTP 接口：
- `GET /health` — 健康检查
- `POST /analyze` — 执行 Slither 分析
- `GET /detectors` — 可用检测器列表

#### 3.2.2 分析流程

```
前端 → /api/slither → Slither Docker → JSON 结果
                                            ↓
                                    slitherAnalyzer.ts
                                            ↓
                                    SlitherAnalysisResult
                                    {success, findings[], summary, duration_ms}
```

`slitherAnalyzer.ts` 负责：
1. 将合约源码发送到 Docker 容器
2. 解析 Slither 的 JSON 输出
3. 将检测结果标准化为 `SlitherFinding[]` 结构
4. 映射 Slither 检测器名称到 SWC 编号

### 3.3 AI 审计模块

#### 3.3.1 提示词工程

AI 审计模块的核心是精心设计的安全审计提示词（Security Audit Prompt）。提示词设计遵循以下原则：

1. **角色设定**：将 LLM 设定为"世界级智能合约安全审计师"，并告知其是双引擎系统的一部分
2. **输出格式严格约束**：要求 Markdown 格式的结构化输出，确保下游融合引擎能可靠解析
3. **漏洞分类按频率排序**：根据 Durieux et al. [7] 的实证数据，将高频漏洞类型排在前面
4. **Chain-of-Thought 推理**：要求模型在报告每个发现前进行 5 步推理

#### 3.3.2 多模型 Provider 抽象

`services/llm/client.ts` 实现了统一的 LLM 调用接口：

```typescript
// 同步调用
chatCompletion(provider, model, messages, options): Promise<string>

// 流式调用
chatCompletionStream(provider, model, messages, options): AsyncGenerator<string>
```

支持的 Provider 通过 OpenAI 兼容接口统一调用，不同 Provider 只需配置不同的 `baseURL` 和 `apiKey`。

#### 3.3.3 StreamAI 流式管道

为提升用户体验，AI 分析采用 5 层流式管道（详见 v7 阶段文档 §3.2）：

```
LLM SSE → 服务器代理 → SSE 解析 → 业务编排 → UI 渲染（150ms 节流）
```

用户在 1–2 秒内即可看到 AI 的首个输出 token，无需等待完整分析结束。

### 3.4 融合引擎

#### 3.4.1 设计理论

融合引擎的设计基于 Dietterich [9] 的集成学习理论。核心思想是：
- 两个"弱检测器"的组合可以获得优于单个"强检测器"的性能
- 不同检测器的错误模式通常不相关，交叉验证可以显著降低误报率

#### 3.4.2 融合算法

融合过程包含以下步骤（实现于 `findingFusion.ts`）：

**Step 1: 标准化**
- Slither 结果：`SlitherFinding[] → UnifiedFinding[]`（归一化严重度、映射 SWC）
- AI 结果：解析 Markdown 报告，提取结构化 Finding

**Step 2: 分类与匹配**
- 12 个漏洞大类（reentrancy、access-control、integer-overflow 等）
- 匹配评分公式：`score = 0.5 × categoryMatch + 0.3 × fileMatch + 0.2 × textSimilarity`

**Step 3: 去重与交叉验证**
- 当 `score > 0.5` 时判定为同一漏洞的不同视角
- 合并双引擎的描述，保留更高严重度
- 置信度标记为 "high"

**Step 4: 报告生成**
- 按严重度降序排列
- 交叉验证的发现优先展示
- 附录中保留 AI 和 Slither 的原始输出

### 3.5 前端实现

#### 3.5.1 技术栈

| 技术 | 用途 |
|------|------|
| Next.js 16 + TypeScript | 全栈框架 |
| Tailwind CSS | 原子化 CSS 框架 |
| Monaco Editor | 代码编辑器（VSCode 引擎） |
| react-markdown | Markdown 渲染 |
| Prism.js | 代码语法高亮 |
| next-themes | 明暗主题切换 |

#### 3.5.2 页面结构

| 页面 | 路由 | 功能 |
|------|------|------|
| 首页 | `/` | 项目介绍、架构图、功能特性 |
| 审计页 | `/audit` | 合约分析入口（3 种模式） |
| 源码页 | `/audit/source` | 源码浏览、文件树、在线分析 |
| 结果页 | `/audit/analyze` | 分析结果展示 |

#### 3.5.3 主题系统

系统采用 CSS 变量 + `next-themes` 实现明暗主题切换：

```css
:root {
  --accent: 5 150 105;  /* emerald-600 */
}
.dark {
  --accent: 16 185 129; /* emerald-500 */
}
```

Monaco Editor 主题通过 `useTheme()` 钩子动态切换（`vs` / `vs-dark`），保持与全局主题的一致性。

---

## 第四章 实验与分析

### 4.1 实验环境

| 项目 | 配置 |
|------|------|
| 操作系统 | Windows 10 22H2 |
| CPU | Intel Core i7-12700H |
| 内存 | 16 GB DDR5 |
| Node.js | v22.x (Next.js 16.1.6 + Turbopack) |
| Docker | Docker Desktop 4.x (WSL2 后端) |
| Slither | v0.10.x（Docker 容器化部署，mush-slither） |
| AI 模型 | DashScope qwen-flash（弗吉尼亚端点） |
| 网络 | HTTP 代理 → 弗吉尼亚 DashScope 端点 |
| 浏览器 | Chrome 最新版 |

### 4.2 测试合约集

| 合约 | 地址 / 来源 | 代码行数 | 特点 |
|------|------------|---------|------|
| USDT (Tether) | `0xdAC17F958D2ee523a2206206994597C13D831ec7` (Ethereum) | ~500 | 生产级 ERC-20 代币合约，包含 Pausable、BlackList、Upgradeable 等功能 |
| Vault 示例 | 系统内置（Single File 模式） | ~70 | 教学用漏洞合约，包含已知的重入攻击、delegatecall 风险等经典漏洞 |

> **说明**：受限于毕设时间周期和 API 调用成本，本文选择了两个代表性合约进行实验。USDT 代表真实生产环境中的大型合约，Vault 代表包含已知漏洞的测试合约。更大规模的对比实验（如 Durieux et al. [7] 的 47,587 合约数据集）列为未来工作。

### 4.3 实验设计

**实验目标**：对比以下三种检测方式在相同合约上的表现：
1. **Slither 单引擎**：仅使用 Slither 静态分析（Docker 容器）
2. **AI 单引擎**：仅使用 LLM 深度审计（DashScope qwen-flash）
3. **双引擎融合**：Slither + AI 并行分析 + Finding Fusion 融合引擎

**评估指标**：
- 检出数量（Total Findings）
- 严重度分布（Critical / High / Medium / Low / Informational / Gas）
- 交叉验证数量（Cross-Validated Findings）
- 各引擎独有发现数量（Slither-Only / AI-Only）
- 分析耗时（Duration in ms）

**实验方法**：
- USDT 合约通过 Agent API（`POST /api/agent/audit`）触发双引擎分析，获取完整的融合结果 JSON
- Vault 合约分别调用 Slither Docker API 和 AI 分析 API，独立收集数据，再手动模拟融合过程
- 所有实验均在相同环境下进行，AI 模型统一使用 DashScope `qwen-flash`

### 4.4 实验结果

#### 4.4.1 实验一：USDT 合约（双引擎融合）

通过 Agent API 调用双引擎分析，结果如下：

**表 4-1：USDT 合约双引擎融合结果汇总**

| 指标 | Slither 引擎 | AI 引擎 | 融合后 |
|------|-------------|---------|-------|
| 原始发现数 | 52 | 5 | **56**（去重 1 项） |
| 交叉验证 | — | — | **1** |
| 高置信度 | — | — | 1 |
| 中置信度 | — | — | 55 |

**表 4-2：USDT 合约融合结果严重度分布**

| 严重度 | 数量 | 占比 |
|--------|------|------|
| Critical | 1 | 1.8% |
| High | 3 | 5.4% |
| Medium | 15 | 26.8% |
| Low | 2 | 3.6% |
| Informational | 32 | 57.1% |
| Gas | 3 | 5.4% |
| **总计** | **56** | **100%** |

**表 4-3：USDT 合约发现来源分布**

| 来源 | 数量 | 说明 |
|------|------|------|
| 仅 Slither | 51 | 静态分析检测的模式漏洞（含大量 Informational 级别） |
| 仅 AI | 4 | LLM 发现的语义/逻辑漏洞 |
| 双引擎交叉验证 | 1 | `onlyPayloadSize` 修饰符使用不一致（Medium，置信度高） |

**表 4-4：USDT 合约 AI 引擎独有发现**

| 严重度 | 发现标题 | 说明 |
|--------|---------|------|
| Critical | Missing Reentrancy Guard in Transfer Functions | AI 识别到转账函数缺少重入保护 |
| High | Blacklist Bypass via Upgraded Contract Interaction | AI 推断出升级机制可绕过黑名单 |
| High | Fee Calculation Vulnerability Due to Decimal Mismatch | AI 发现精度计算逻辑缺陷 |
| High | Upgrade Mechanism Allows Owner to Evade Blacklist | AI 发现特权角色风险 |

**表 4-5：USDT 合约分析耗时**

| 引擎 | 耗时 |
|------|------|
| Slither | 1,887 ms（1.9 秒） |
| AI (qwen-flash) | 47,657 ms（47.7 秒） |
| **总计（并行执行）** | **48,200 ms（48.2 秒）** |

> **注**：双引擎并行执行，总耗时约等于较慢引擎（AI）的耗时，仅增加了约 543ms 的融合计算开销。

#### 4.4.2 实验二：Vault 合约（三种模式对比）

**表 4-6：Vault 合约三种检测模式对比**

| 指标 | Slither 单引擎 | AI 单引擎 | 双引擎融合（预期） |
|------|---------------|----------|-----------------|
| 总发现数 | 13 | 5 | ~16（去重 2 项） |
| 交叉验证 | — | — | 2（delegatecall + reentrancy） |
| 耗时 | 1,334 ms | 13,727 ms | ~14,000 ms |

**表 4-7：Vault 合约 Slither 引擎发现详情**

| 严重度 | 数量 | 检测器 | 说明 |
|--------|------|--------|------|
| High | 2 | `controlled-delegatecall`、`reentrancy-eth` | **核心漏洞**：delegatecall 注入 + 重入攻击 |
| Medium | 2 | `incorrect-equality`、`tautology` | `isSolve()` 严格等值判断 + `withdraw()` 恒真条件 |
| Low | 1 | `missing-zero-check` | `changeOwner` 缺少零地址检查 |
| Informational | 5 | `solc-version`、`low-level-calls` ×2、`naming-convention`、`redundant-statements` | 代码规范和信息提示 |
| Gas/Optimization | 3 | `immutable-states` ×3 | `password`、`logic`、`owner` 可设为 `immutable` |

**表 4-8：Vault 合约 AI 引擎发现详情**

| 严重度 | 发现标题 | 对应 SWC | Slither 是否检出 |
|--------|---------|---------|----------------|
| Critical | Incorrect Use of Delegatecall Without Proper Access Control | SWC-112 | ✓ (`controlled-delegatecall`) |
| High | Insecure Password Comparison in changeOwner Function | — | ✗ **AI 独有** |
| High | Unprotected withdraw Allows Withdrawal Without Balance Check | — | 部分（`tautology` 检测器） |
| Medium | Missing Reentrancy Protection in withdraw Function | SWC-107 | ✓ (`reentrancy-eth`) |
| Low | Misleading isSolve Returns True When Balance Is Zero | — | 部分（`incorrect-equality`） |

### 4.5 结果分析

#### 4.5.1 互补性验证

实验结果清楚地证明了双引擎的互补性：

**Slither 擅长但 AI 可能遗漏的领域**：
- **代码规范类问题**：Slither 检出大量 Informational 级别的代码规范问题（命名约定、冗余语句、编译器版本等），AI 通常不会报告这些低级别问题
- **Gas 优化建议**：Slither 精确识别了 3 处可优化为 `immutable` 的状态变量，AI 对此不敏感
- **定量化指标**：USDT 合约中 Slither 独有 51 个发现，占总量的 91%

**AI 擅长但 Slither 无法检出的领域**：
- **业务逻辑缺陷**：Vault 合约中 AI 发现了 "Insecure Password Comparison"——`password` 虽是 `private` 但区块链上所有存储槽可读，攻击者可从链上读取 `password` 值。**这是一个语义级别的漏洞，Slither 的模式匹配无法检出**
- **特权角色风险**：USDT 合约中 AI 发现了升级机制可能导致的黑名单绕过风险，这需要理解合约的业务逻辑
- **跨函数攻击链**：AI 能构建从 `delegatecall` → 存储碰撞 → `owner` 篡改的完整攻击路径描述

这一发现与 Durieux et al. [7] 的结论一致：**不同工具的检测能力互补，组合使用优于单一工具**。

#### 4.5.2 交叉验证效果

| 合约 | 交叉验证数 | 交叉验证发现 | 置信度提升 |
|------|-----------|-------------|-----------|
| USDT | 1 | `onlyPayloadSize` 修饰符使用不一致 | medium → **high** |
| Vault | 2（预期） | delegatecall 注入 + 重入攻击 | medium → **high** |

交叉验证的核心价值在于**提升置信度**——当两个基于完全不同原理的检测引擎（静态分析 vs 语义理解）同时发现同一漏洞时，该漏洞为真阳性的概率显著提高。这一原理与 Dietterich [9] 的集成学习理论一致。

#### 4.5.3 误报分析

| 引擎 | 误报特征 | 示例 |
|------|---------|------|
| Slither | 假阳性率低，但 Informational 级别信息量大、价值密度低 | USDT 的 32 个 Informational 中，大部分为代码风格提示 |
| AI | 可能报告理论上存在但实际难以利用的漏洞 | USDT 的 "Missing Reentrancy Guard" — 该合约的 `transfer` 函数实际上没有外部调用，重入风险较低 |
| 融合引擎 | 通过交叉验证，仅 `sources: ["slither", "ai"]` 的发现标记为高置信度，有效区分了确定性发现和待确认发现 | — |

#### 4.5.4 性能分析

**表 4-9：各引擎性能对比**

| 引擎 | USDT 耗时 | Vault 耗时 | 特点 |
|------|----------|-----------|------|
| Slither | 1,887 ms | 1,334 ms | 确定性分析，耗时稳定 |
| AI (qwen-flash) | 47,657 ms | 13,727 ms | 与合约长度正相关 |
| 双引擎总计 | 48,200 ms | ~14,000 ms | ≈ max(Slither, AI) + 融合开销 |

**关键观察**：
1. Slither 的执行时间极为稳定（1–2 秒），不受合约规模显著影响
2. AI 的执行时间与合约代码长度正相关（USDT ~500 行 → 48 秒，Vault ~70 行 → 14 秒）
3. 双引擎并行执行的总耗时接近单 AI 引擎耗时——**Slither 分析在 AI 分析期间完成，几乎不增加额外时间成本**

这一性能特性证明了并行架构的合理性：Slither 的快速扫描在 AI 深度分析的"等待时间"内免费完成，双引擎的信息增益几乎没有时间代价。

#### 4.5.5 实验小结

| 评估维度 | Slither 单引擎 | AI 单引擎 | 双引擎融合 |
|---------|---------------|----------|-----------|
| 模式漏洞检出 | 强 | 弱 | **强** |
| 语义/逻辑漏洞 | 弱 | 强 | **强** |
| 误报率 | 低（但 Informational 多） | 中等 | **低**（交叉验证） |
| 置信度 | 中（规则确定性） | 中（LLM 不确定性） | **高**（双引擎共识） |
| 耗时 | ~2 秒 | 14–48 秒 | 14–48 秒（并行） |
| 信息丰富度 | 代码定位精确 | 攻击场景完整 | **两者兼具** |

---

## 第五章 总结与展望

### 5.1 工作总结

本文设计并实现了 ChainVine——一个基于 Slither 静态分析与 AI 大语言模型的双引擎智能合约漏洞扫描系统。系统主要功能包括：

1. **双引擎并行分析**：Slither 和 LLM 同时处理合约代码，互不阻塞
2. **结果融合引擎**：通过分类匹配、位置匹配和文本相似度实现漏洞去重和交叉验证
3. **多链源码获取**：支持 8 条 EVM 链的已验证合约源码自动获取
4. **代理合约识别**：自动检测 EIP-1967 / UUPS / Beacon 代理模式
5. **StreamAI 流式输出**：5 层流式管道实现 AI 输出的实时展示
6. **多模型 Provider**：支持 DashScope / OpenAI / Neversight 三种 Provider
7. **Agent API**：RESTful + SSE 接口，支持程序化调用

### 5.2 创新点

1. **双引擎互补架构**：首次在同一 Web 平台中系统性地融合 Slither 静态分析和 LLM 深度审计
2. **Finding Fusion 算法**：设计了多维度匹配的漏洞融合算法，通过交叉验证提升检测可信度
3. **StreamAI 实时反馈**：5 层流式管道设计，将 LLM 输出延迟从分钟级降低到秒级
4. **多链 + 代理合约**：8 链覆盖 + 三种代理模式自动识别，提升实用性

### 5.3 不足与局限

1. **测试规模有限**：受限于时间和 API 成本，未能在大规模合约集上进行系统性评估
2. **融合算法的阈值**：匹配分数阈值（0.5）为经验值，未经过严格的参数调优
3. **LLM 幻觉问题**：AI 引擎仍可能产生误报，交叉验证只能缓解但无法完全消除
4. **无符号执行引擎**：未集成 Mythril 等符号执行工具，在路径可达性验证方面有局限

### 5.4 未来工作

1. **Mythril 集成**：引入符号执行作为第三引擎，进一步增强漏洞检测的深度和全面性
2. **多模型交叉审计**：同时调用多个 LLM（如 Claude + GPT + Qwen），通过模型间共识进一步降低误报
3. **大规模实证评估**：在 Durieux et al. [7] 的 47,587 合约数据集上进行系统性对比评估
4. **形式化验证集成**：引入 SMT 求解器对关键安全属性进行形式化验证
5. **历史审计记录**：添加本地存储功能，记录历史审计结果，支持趋势分析

---

## 参考文献

[1] Buterin, V., "A Next-Generation Smart Contract and Decentralized Application Platform", Ethereum White Paper, 2014.

[2] DeFi Llama, "Total Value Locked in DeFi", https://defillama.com/, 2025.

[3] Consensys Diligence, "Smart Contract Security Audit Pricing", 2024.

[4] Feist, J., Grieco, G., Groce, A., "Slither: A Static Analysis Framework for Smart Contracts", Proceedings of the 2nd International Workshop on Emerging Trends in Software Engineering for Blockchain (WETSEB), 2019.

[5] Mueller, B., "Mythril: A Security Analysis Tool for Ethereum Smart Contracts", GitHub Repository, 2018.

[6] Tsankov, P., Dan, A., Drachsler-Cohen, D., Gervais, A., Bünzli, F., Vechev, M., "Securify: Practical Security Analysis of Smart Contracts", Proceedings of the 2018 ACM SIGSAC Conference on Computer and Communications Security (CCS), 2018.

[7] Durieux, T., Ferreira, J.F., Abreu, R., Cruz, P., "Empirical Review of Automated Analysis Tools on 47,587 Ethereum Smart Contracts", Proceedings of the ACM International Conference on the Foundations of Software Engineering (FSE), 2020.

[8] David, A., Desprats, T., Music, L., "Do you still need a manual smart contract audit?", arXiv:2306.12338, 2023.

[9] Dietterich, T.G., "Ensemble Methods in Machine Learning", International Workshop on Multiple Classifier Systems (MCS), 2000.

[10] Chen, Y., et al., "Large Language Models for Blockchain Security: A Systematic Literature Review", arXiv, 2024.

[11] Nielsen, J., "Response Time Limits: Article by Jakob Nielsen", Nielsen Norman Group, 1993.

[12] Yao, S., Zhao, J., Yu, D., Du, N., Shafran, I., Narasimhan, K., Cao, Y., "ReAct: Synergizing Reasoning and Acting in Language Models", International Conference on Learning Representations (ICLR), 2023.

[13] Solidity Documentation, "Solidity — Solidity 0.8.x Documentation", https://docs.soliditylang.org/.

[14] SWC Registry, "Smart Contract Weakness Classification and Test Cases", https://swcregistry.io/.

[15] Vaswani, A., Shazeer, N., Parmar, N., et al., "Attention Is All You Need", Advances in Neural Information Processing Systems (NeurIPS), 2017.

[16] Wei, J., Wang, X., Schuurmans, D., et al., "Chain-of-Thought Prompting Elicits Reasoning in Large Language Models", Advances in Neural Information Processing Systems (NeurIPS), 2022.

[17] Zhou, Y., et al., "Large Language Models Are Human-Level Prompt Engineers", International Conference on Learning Representations (ICLR), 2023.

[18] SlowMist, "2025 Blockchain Security and AML Analysis Annual Report", 2025.

[19] Alibaba Cloud, "DashScope API Reference", https://help.aliyun.com/zh/model-studio/, 2026.

[20] Alibaba Cloud, "Qwen3-Coder Technical Report", 2025.

---

## 致谢

（此处添加对指导老师、同学、家人的感谢。答辩前完成。）

---

*基于静态分析与大语言模型的智能合约漏洞扫描系统的设计与实现*  
*成都信息工程大学 · 信息安全专业 · 2026 届本科毕业设计*
