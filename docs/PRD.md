# 区块链智能合约漏洞扫描系统 — 产品需求文档 (PRD)

> **项目名称**：基于静态分析与大语言模型的智能合约漏洞扫描系统  
> **作者**：[你的姓名]  
> **院校**：成都信息工程大学 · 信息安全专业  
> **版本**：v1.0  
> **日期**：2026-02-08  
> **截止日期**：2026-03 答辩

---

## 1. 项目概述

### 1.1 背景与动机

智能合约一经部署即不可修改（immutable），漏洞造成的经济损失不可逆转。据 SlowMist 2025 年度报告统计，全年因智能合约漏洞导致的损失超过 **$20 亿美元**。

当前智能合约安全审计面临两大挑战：

1. **传统静态分析工具**（如 Slither）擅长检测已知模式漏洞（重入攻击、未检查返回值等），但对业务逻辑缺陷和复杂跨函数漏洞的检测能力有限。
2. **大语言模型 (LLM)** 具备强大的代码理解和语义推理能力，能发现传统工具遗漏的逻辑漏洞，但存在幻觉（hallucination）问题，可能产生误报。

> **参考文献**：
> - Feist et al., *"Slither: A Static Analysis Framework for Smart Contracts"*, WETSEB 2019
> - David et al., *"Do you still need a manual smart contract audit?"*, arXiv 2023
> - Chen et al., *"Large Language Models for Blockchain Security: A Systematic Literature Review"*, arXiv 2024

### 1.2 项目目标

构建一个**双引擎智能合约漏洞扫描系统**，将传统静态分析工具 Slither 与 LLM 深度审计相结合，实现互补性漏洞检测：

- **Slither 引擎**：快速扫描已知漏洞模式，提供精确的代码定位
- **AI 引擎**：深度语义分析，发现业务逻辑漏洞和复杂攻击路径
- **融合引擎**：交叉验证两个引擎的结果，去重、评分、生成统一报告

### 1.3 非目标 (Non-Goals)

- ❌ 链上交易执行或模拟
- ❌ 形式化验证或语义等价性检查
- ❌ 私有源码获取（仅支持公开已验证源码）
- ❌ Mythril 符号执行集成（受限于时间，列为未来工作）

---

## 2. 功能需求

### 2.1 核心功能（必做 - P0）

| ID | 功能 | 描述 | 验收标准 |
|----|------|------|---------|
| F-01 | **合约地址输入** | 用户输入合约地址 + 选择 EVM 链 | 支持 Ethereum/BSC/Arbitrum/Base/Optimism/Polygon/Avalanche/Aurora |
| F-02 | **链上源码获取** | 自动从 Explorer API 获取已验证源码 | 支持单文件/多文件/代理合约 |
| F-03 | **代理合约检测** | 自动识别 EIP-1967/UUPS/Beacon 代理模式 | 正确分离 proxy 和 implementation 源码 |
| F-04 | **Slither 静态分析** | 调用 Slither 扫描合约，解析 JSON 结果 | 输出漏洞列表（类型/严重度/代码位置/描述） |
| F-05 | **AI 深度审计** | 调用 LLM 进行语义级安全分析 | 输出 Markdown 格式审计报告 |
| F-06 | **结果融合** | 合并 Slither 和 AI 的发现，去重+交叉验证 | 统一格式的漏洞清单，标注来源引擎和置信度 |
| F-07 | **审计报告展示** | 在 Web UI 中展示完整审计报告 | 支持按严重度过滤、代码定位高亮 |
| F-08 | **报告导出** | 支持 Markdown/ZIP 格式导出 | 一键下载完整报告 |

### 2.2 增强功能（选做 - P1）

| ID | 功能 | 描述 |
|----|------|------|
| F-09 | 源码文件浏览器 | 树形结构浏览合约源码文件 |
| F-10 | 多 AI 模型选择 | 支持 Claude/GPT/Gemini/通义千问/DeepSeek |
| F-11 | 中英文报告切换 | 根据用户偏好生成中/英文报告 |
| F-12 | Super Prompt 模式 | 增强型 Prompt 激活更深层分析 |
| F-13 | 合约上传扫描 | 直接上传 .sol 文件扫描（不通过链上获取） |

### 2.3 延伸功能（未来工作 - P2）

| ID | 功能 | 描述 |
|----|------|------|
| F-14 | Mythril 符号执行集成 | 第三引擎，形式化路径探索 |
| F-15 | 扫描历史记录 | 本地存储历史审计记录 |
| F-16 | 多模型交叉审计 | 多 LLM 同时分析，共识度评分 |
| F-17 | 更多 EVM 链支持 | Scroll/Linea/zkSync/HashKey Chain |

---

## 3. 非功能需求

| 维度 | 要求 |
|------|------|
| **性能** | Slither 扫描 < 60s（中等规模合约）；AI 分析 < 120s |
| **安全性** | Slither 在 Docker 容器中隔离运行；API Key 不传输到后端服务器 |
| **可用性** | Web UI 响应流畅，扫描过程有进度反馈 |
| **可部署性** | 支持 `docker-compose up` 一键启动全部服务 |
| **兼容性** | 支持 Chrome/Edge/Firefox 最新版本 |
| **可维护性** | TypeScript 类型安全；模块化架构；核心模块有注释 |

---

## 4. 系统架构

### 4.1 总体架构

```
┌─────────────────────────────────────────────────────────┐
│                      用户浏览器                          │
│  ┌─────────────────────────────────────────────────┐    │
│  │           Next.js Web UI (TypeScript)            │    │
│  │  首页 → 审计页 → 源码浏览 → 分析结果 → 报告导出  │    │
│  └───────────────────┬─────────────────────────────┘    │
└───────────────────────┼─────────────────────────────────┘
                        │
          ┌─────────────┼─────────────────┐
          ↓             ↓                 ↓
   ┌────────────┐ ┌──────────┐    ┌──────────────┐
   │ /api/      │ │ /api/    │    │ /api/        │
   │ contract-  │ │ source   │    │ slither      │
   │ info       │ │          │    │ (新增)       │
   └─────┬──────┘ └────┬─────┘    └──────┬───────┘
         ↓              ↓                 ↓
   ┌─────────────┐ ┌─────────┐   ┌──────────────┐
   │ Explorer    │ │Explorer │   │ Docker       │
   │ API         │ │API      │   │ Slither      │
   │ (元数据)    │ │(源码)   │   │ Container    │
   └─────────────┘ └─────────┘   └──────────────┘

          ┌──────────────────────────────┐
          │        审计引擎层             │
          │                              │
          │  ┌──────────┐ ┌──────────┐   │
          │  │ Slither   │ │ AI(LLM)  │   │
          │  │ 引擎      │ │ 引擎     │   │
          │  └─────┬─────┘ └────┬─────┘   │
          │        └──────┬─────┘          │
          │         ┌─────┴──────┐         │
          │         │ 融合引擎   │         │
          │         └─────┬──────┘         │
          │               ↓                │
          │        ┌─────────────┐         │
          │        │ 统一报告    │         │
          │        └─────────────┘         │
          └──────────────────────────────┘
```

### 4.2 技术选型

| 层次 | 技术 | 选型理由 |
|------|------|---------|
| **前端框架** | Next.js 16 + TypeScript | App Router + API Routes 一体化；Turbopack 快速热更新 |
| **UI 框架** | Tailwind CSS + Headless UI | 快速迭代，暗色主题，组件化 |
| **代码编辑器** | Monaco Editor | VSCode 级别的代码浏览体验 |
| **静态分析** | Slither (Python) | 业界标准，Trail of Bits 出品，支持 80+ 检测器 |
| **容器化** | Docker + docker-compose | 隔离 Slither 运行环境，确保安全和可复现 |
| **AI 集成** | 多模型支持 (OpenAI/Claude/Gemini/通义千问/DeepSeek) | 通过 Neversight API 网关 + 直连两种模式 |
| **区块链交互** | ethers.js v6 | 标准 EVM RPC 客户端 |
| **Markdown 渲染** | react-markdown + marked | 审计报告展示 |

### 4.3 Slither 检测器覆盖范围

基于 Slither 内置 80+ 检测器，重点覆盖以下漏洞类别（映射到 SWC Registry）：

| 漏洞类别 | SWC ID | Slither 检测器示例 |
|---------|--------|-------------------|
| 重入攻击 | SWC-107 | `reentrancy-eth`, `reentrancy-no-eth` |
| 未检查外部调用返回值 | SWC-104 | `unchecked-lowlevel`, `unchecked-send` |
| 访问控制缺陷 | SWC-105 | `unprotected-upgrade`, `suicidal` |
| 整数溢出/下溢 | SWC-101 | `controlled-array-length` |
| tx.origin 认证 | SWC-115 | `tx-origin` |
| 未初始化存储指针 | SWC-109 | `uninitialized-storage` |
| 时间戳依赖 | SWC-116 | `timestamp` |
| 影子变量 | SWC-119 | `shadowing-state`, `shadowing-local` |

> **参考**：[SWC Registry](https://swcregistry.io/)，Smart Contract Weakness Classification and Test Cases

---

## 5. 数据流

### 5.1 主流程

```
用户输入合约地址+链
        ↓
  /api/contract-info  →  获取元数据（名称/编译器/代理检测）
        ↓
  /api/source         →  获取已验证源码（处理代理合约分离）
        ↓
  用户触发扫描
        ↓
  ┌─────────────────────────────────────┐
  │          并行执行                    │
  │                                     │
  │  Slither 引擎          AI 引擎      │
  │  (Docker 容器)         (LLM API)    │
  │       ↓                    ↓        │
  │  JSON 漏洞结果      Markdown 报告   │
  └───────────┬─────────────┬───────────┘
              ↓             ↓
         结果融合引擎
              ↓
        统一审计报告
              ↓
        Web UI 展示 + 导出
```

### 5.2 Slither 数据流（新增）

```
合约源码 (.sol)
     ↓
Next.js API Route (/api/slither)
     ↓
写入临时文件 → 挂载到 Docker 容器
     ↓
Docker: slither /contracts/target.sol --json -
     ↓
解析 JSON → 提取 detectors[] → 标准化为 SlitherFinding[]
     ↓
返回前端
```

---

## 6. 里程碑计划

| 周次 | 日期 | 里程碑 | 核心交付物 | 论文对应章节 |
|------|------|--------|-----------|-------------|
| **W1** | 2/8 - 2/14 | **Slither 集成** | Docker 化 Slither 服务；`/api/slither` 路由；结果解析器 | 第三章：系统设计与实现 |
| **W2** | 2/15 - 2/21 | **双引擎融合 + UI** | 结果合并算法；对比视图组件；统一报告页面 | 第三章 + 第四章：实验设计 |
| **W3** | 2/22 - 2/28 | **实验 + 论文** | 10-20 个合约对比测试数据；论文初稿 | 第四章：实验与分析 |
| **W4** | 3/1 - 3/7 | **答辩准备** | PPT；演示视频；Q&A 清单；论文终稿 | 全文定稿 |

---

## 7. 论文章节规划（预览）

| 章节 | 标题 | 核心内容 |
|------|------|---------|
| 第一章 | 绪论 | 研究背景（智能合约安全现状）、研究意义、国内外研究现状、本文工作 |
| 第二章 | 相关技术 | Solidity/EVM 基础、静态分析原理（AST/CFG/数据流）、LLM 代码理解能力 |
| 第三章 | 系统设计与实现 | 架构设计、Slither 集成、AI 审计模块、融合引擎、前端实现 |
| 第四章 | 实验与分析 | 测试合约集、单引擎 vs 双引擎检出率对比、误报/漏报分析 |
| 第五章 | 总结与展望 | 工作总结、创新点、不足与未来工作（Mythril/多模型交叉审计） |

---

## 8. 风险与缓解

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| Slither Docker 集成遇阻 | 中 | 高 | 备选方案：Windows 直接 pip 安装 Slither |
| LLM API 不稳定/超时 | 低 | 中 | 多模型切换 + 重试机制（已实现） |
| 大型合约超出 LLM 上下文窗口 | 中 | 中 | 合约过滤器去除第三方库（已实现） |
| 时间不足 | 中 | 高 | P0 功能优先；P1/P2 列为未来工作 |
| Explorer API 速率限制 | 低 | 低 | 免费 API Key + 请求间隔控制 |

---

## 9. 创新点总结（答辩用）

1. **双引擎互补架构**：首次将 Slither 静态分析与 LLM 深度审计集成在同一平台，实现检测能力互补
2. **结果融合算法**：设计漏洞去重与交叉验证机制，通过双引擎共识提升发现置信度
3. **多链 + 代理合约支持**：覆盖 8 条 EVM 链，自动识别 EIP-1967/UUPS/Beacon 代理模式
4. **容器化安全隔离**：Slither 运行在 Docker 沙箱中，防止恶意合约代码逃逸

---

*文档结束。本文档同时作为毕业论文需求分析和系统设计章节的基础素材。*
